<!DOCTYPE html>
<html>
<head>
    <title>TRGL ORB</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 15px;
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }
        #log {
            height: 65vh;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
            background: #111;
            white-space: pre-wrap;
            font-size: 13px;
        }
        .entry {
            margin: 3px 0;
        }
        .time {
            color: #00ff00aa;
        }
        input, button {
            padding: 8px;
            margin: 3px;
            background: #222;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: 'Courier New';
            font-size: 14px;
        }
        button {
            cursor: pointer;
            min-width: 100px;
        }
        button:hover {
            background: #0f0;
            color: #000;
            font-weight: bold;
        }
        .status-bar {
            font-size: 12px;
            color: #00ff0080;
            margin: 10px 0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .notification {
            padding: 6px 10px;
            margin: 4px 0;
            background: #1a1a1a;
            border-left: 3px solid #00b7eb;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .notification.success { border-left-color: #00ff00; }
        .notification.error { border-left-color: #ff3b3b; }
        .notification.omega {
            color: #ff00ff;
            font-weight: bold;
        }
        .ai-chat {
            color: #00bfff;
            font-style: italic;
        }
        .cmd-input {
            width: 200px;
        }
        .full-width {
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

    <h2>> THE_ORB v8.1-LIGHT <span id="status">Connecting...</span></h2>

    <div class="status-bar">
        <div>Agents: <span id="agentCount">0</span></div>
        <div>Reports: <span id="reportsCount">0</span></div>
        <div>Threats: <span id="threatCount">0</span></div>
        <div>Mode: <span id="mode">Normal</span></div>
    </div>

    <div id="log"></div>

    <input type="text" id="agentId" placeholder="agent_id" class="cmd-input" />
    <input type="text" id="cmdInput" placeholder="command (e.g. scan_target)" class="cmd-input" />
    <button onclick="sendCommand()">🚀 Send</button>
    <button onclick="broadcastCommand()">📢 All</button>
    <button onclick="fetchData()">🔄 Refresh</button>

    <script>
        let ws = null;
        const log = document.getElementById("log");
        const counters = {
            agentCount: document.getElementById("agentCount"),
            reportsCount: document.getElementById("reportsCount"),
            threatCount: document.getElementById("threatCount"),
        };
        const mode = document.getElementById("mode");

        function print(line) {
            const div = document.createElement("div");
            div.className = "entry";
            const time = new Date().toLocaleTimeString();
            div.innerHTML = `<span class="time">[${time}]</span> ${line}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function notify(msg, type = 'info') {
            const div = document.createElement("div");
            div.className = `notification ${type}`;
            div.textContent = msg;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
            setTimeout(() => {
                div.style.opacity = 0;
                setTimeout(() => div.remove(), 300);
            }, 5000);
        }

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            ws = new WebSocket(`${protocol}//${host}/ws`);
            document.getElementById("status").textContent = "Connecting...";
            document.getElementById("status").style.color = "#ffeb3b";

            ws.onopen = () => {
                document.getElementById("status").textContent = "ACTIVE";
                document.getElementById("status").style.color = "#00ff00";
                notify("✅ Orb connected. Sentinel online.", "success");
                fetchData();
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === "report") {
                        const r = data.data;
                        const ip = r.data?.ip || 'unknown';
                        const traffic = r.data?.network_traffic || 0;
                        const isAnomaly = r.data?.is_anomaly ? '🚨' : '📡';
                        print(`${isAnomaly} ${r.agent_id} | ${ip} | Traffic: ${traffic}`);
                    }

                    if (data.type === "ai_alert") {
                        const a = data.data;
                        const color = a.threat ? "#ffeb3b" : "#00ff00";
                        const div = document.createElement("div");
                        div.innerHTML = `<span style="color:${color}">🤖 ${a.message}</span>`;
                        log.appendChild(div);
                        log.scrollTop = log.scrollHeight;
                    }

                    if (data.type === "ai_chat") {
                        const c = data.data;
                        const levelClass = c.level === 'omega' ? 'omega' : 
                                         c.level === 'success' ? 'success' : 
                                         c.level === 'error' ? 'error' : 'ai-chat';
                        const div = document.createElement("div");
                        div.className = levelClass;
                        div.innerHTML = `💬 [${c.from} → ${c.to}] ${c.message}`;
                        log.appendChild(div);
                        log.scrollTop = log.scrollHeight;
                    }

                    if (data.type === "command") {
                        notify(`📤 Command sent: ${data.data.command}`, "success");
                    }

                    fetchData(); // Update counters
                } catch (e) {
                    console.error("Parse error:", e);
                }
            };

            ws.onerror = (err) => {
                console.error("WS Error:", err);
            };

            ws.onclose = () => {
                document.getElementById("status").textContent = "DISCONNECTED";
                document.getElementById("status").style.color = "#ff9800";
                notify("🔁 Connection lost. Reconnecting...", "error");
                setTimeout(connect, 3000);
            };
        }

        async function fetchData() {
            try {
                // Simulasi update counter
                // Di versi lengkap, bisa fetch /api/data
                counters.agentCount.textContent = window.agents?.length || 0;
            } catch (e) {
                // optional
            }
        }

        async function sendCommand() {
            const agentId = document.getElementById("agentId").value.trim();
            const cmd = document.getElementById("cmdInput").value.trim();
            if (!agentId || !cmd) {
                return notify("❗ agent_id dan command wajib diisi.", "error");
            }
            try {
                const res = await fetch("/api/command", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ agent_id: agentId, command: cmd })
                });
                const result = await res.json();
                notify(`✅ Sent: ${cmd} → ${agentId}`, "success");
            } catch (err) {
                notify("❌ Gagal kirim perintah.", "error");
            }
        }

        async function broadcastCommand() {
            const cmd = document.getElementById("cmdInput").value.trim();
            if (!cmd) return notify("❗ Masukkan command.", "error");
            try {
                const res = await fetch("/api/command", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ agent_id: "all", command: cmd })
                });
                notify(`📢 Broadcast: ${cmd} ke semua agent`, "success");
            } catch (err) {
                notify("❌ Gagal broadcast.", "error");
            }
        }

        // Auto-connect saat halaman siap
        document.addEventListener("DOMContentLoaded", () => {
            connect();
            setInterval(fetchData, 10000); // Refresh tiap 10 detik
        });
    </script>
</body>
</html>